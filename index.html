<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Pintar - Ditenagai Gemini AI</title>
    <meta name="description" content="Ekstrak teks dari gambar secara akurat dengan kekuatan Google Gemini AI. Mendukung Bahasa Indonesia, Arab, dan lainnya.">

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter (General) & Noto Sans Arabic (for Arabic text) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply custom fonts */
        body { font-family: 'Inter', sans-serif; }
        .font-arabic { font-family: 'Noto Sans Arabic', sans-serif; }
        
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Smooth transitions for a polished feel */
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 antialiased min-h-screen flex items-center justify-center p-4">

    <!-- Sidebar Menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-slate-800 z-50 shadow-lg transform -translate-x-full sidebar-transition">
        <div class="p-4 flex flex-col h-full">
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-bold text-lg text-sky-600 dark:text-sky-400">Menu</h2>
                    <button id="close-sidebar-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <nav class="flex flex-col gap-2">
                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        <span>Tentang Web</span>
                    </a>
                    <a href="#" class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-text"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M13 8H7"/><path d="M17 12H7"/></svg>
                        <span>Kritik & Saran</span>
                    </a>
                </nav>
            </div>
            <div class="mt-auto">
                <label for="api-key-input" class="text-sm font-medium text-slate-600 dark:text-slate-400">Kunci API Gemini</label>
                <input type="password" id="api-key-input" placeholder="Masukkan kunci API Anda" class="mt-1 w-full p-2 border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 rounded-lg text-sm focus:ring-2 focus:ring-sky-500 focus:outline-none">
                <p class="text-xs text-slate-400 mt-1">Kunci disimpan di browser Anda.</p>
            </div>
        </div>
    </aside>

    <div id="app-container" class="w-full max-w-6xl bg-slate-100 dark:bg-slate-900/50 p-4 sm:p-6 md:p-8 rounded-2xl shadow-sm transition-all duration-300">
        
        <!-- Header & Navigation -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                 <button id="menu-btn" title="Buka Menu" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                </button>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold text-sky-600 dark:text-sky-400">OCR Pintar</h1>
                    <p class="text-slate-500 dark:text-slate-400 mt-1 text-xs sm:text-sm">Diperkuat oleh Gemini AI</p>
                </div>
            </div>
            <nav class="flex items-center gap-2">
                <button id="theme-toggle" title="Ubah Tema" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </button>
            </nav>
        </header>

        <!-- View Mode Selector -->
        <div class="flex justify-center items-center gap-2 mb-6">
            <button data-view="mobile" class="view-btn p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800" title="Tampilan HP">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-smartphone"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
            </button>
             <button data-view="tablet" class="view-btn p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-800" title="Tampilan Tablet">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tablet"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><line x1="12" x2="12.01" y1="18" y2="18"/></svg>
            </button>
            <button data-view="laptop" class="view-btn p-2 rounded-lg bg-slate-200 dark:bg-slate-800" title="Tampilan Laptop">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop"><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55A1 1 0 0 1 20.7 20H3.3a1 1 0 0 1-.58-1.45L4 16"/></svg>
            </button>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">
            <!-- Kolom Input Gambar -->
            <div class="flex flex-col h-[50vh] lg:h-auto">
                <div class="mb-3">
                    <p class="text-sm text-slate-500 dark:text-slate-400">
                        Tempel (<kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">Ctrl</kbd>+<kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg dark:bg-gray-700 dark:text-gray-100 dark:border-gray-600">V</kbd>) atau klik untuk unggah.
                    </p>
                </div>
                <div id="paste-area" class="relative w-full flex-grow bg-white dark:bg-slate-800/50 border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex justify-center items-center text-center p-4 cursor-pointer hover:border-sky-500 dark:hover:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500" tabindex="0">
                    <div id="paste-placeholder" class="text-slate-400 dark:text-slate-500 transition-opacity duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload-cloud mx-auto mb-2"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <p>Tempel gambar atau klik untuk unggah</p>
                    </div>
                    <img id="pasted-image" src="" alt="Gambar yang ditempel" class="hidden max-w-full max-h-full object-contain rounded-lg"/>
                    <div id="loader" class="absolute inset-0 bg-black/70 flex flex-col justify-center items-center text-white rounded-xl hidden transition-opacity duration-300">
                        <svg class="animate-spin h-8 w-8 text-white mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <p id="loader-text" class="text-sm font-medium">Memproses gambar...</p>
                    </div>
                </div>
                <input type="file" id="file-upload" class="hidden" accept="image/*">
            </div>

            <!-- Kolom Hasil Teks -->
            <div class="flex flex-col h-[50vh] lg:h-auto">
                <div class="flex justify-between items-center mb-3">
                     <h2 class="font-semibold text-lg">Hasil Teks</h2>
                     <div class="flex items-center gap-2">
                        <!-- GEMINI BUTTONS -->
                        <button id="gemini-explain-btn" title="Jelaskan dengan AI ✨" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-sky-500" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.9 4.2-4.2 1.9 4.2 1.9 1.9 4.2 1.9-4.2 4.2-1.9-4.2-1.9L12 3z"/><path d="M5 13l1.9 4.2 4.2 1.9-4.2 1.9L5 23l-1.9-4.2-4.2-1.9 4.2-1.9L5 13z"/></svg>
                        </button>
                        <button id="gemini-translate-btn" title="Terjemahkan ke Indonesia ✨" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-sky-500" disabled>
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-languages"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                        </button>
                        <div class="h-5 w-px bg-slate-300 dark:bg-slate-700"></div>
                        <!-- STANDARD BUTTONS -->
                        <button id="clear-btn" title="Hapus Hasil" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-sky-500" disabled>
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                        <button id="copy-btn" title="Salin Hasil" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-sky-500" disabled>
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>
                        <button id="save-btn" title="Simpan sebagai .txt" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-sky-500" disabled>
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        </button>
                     </div>
                </div>
                <textarea id="output-text" readonly class="font-arabic w-full flex-grow bg-white dark:bg-slate-800/50 border border-slate-300 dark:border-slate-700 rounded-xl p-4 resize-none focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Hasil ekstraksi teks akan muncul di sini..."></textarea>
            </div>
        </main>
        
        <!-- Notifikasi -->
        <div id="notification" class="fixed bottom-5 right-5 text-white text-sm py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-500 ease-out z-50">
            Pesan notifikasi
        </div>
    </div>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal-overlay" class="fixed inset-0 bg-black/60 z-[99] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="gemini-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-white dark:bg-slate-800 z-[100] rounded-2xl shadow-lg p-6 transform scale-95 opacity-0 pointer-events-none transition-all duration-300">
        <div class="flex justify-between items-center mb-4">
            <h3 id="gemini-modal-title" class="text-xl font-bold text-sky-600 dark:text-sky-400">Hasil dari AI ✨</h3>
            <button id="gemini-modal-close-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <div id="gemini-modal-content" class="max-h-[60vh] overflow-y-auto pr-2 font-arabic text-slate-700 dark:text-slate-300 whitespace-pre-wrap">
            <!-- Gemini result will be inserted here -->
        </div>
        <div id="gemini-modal-loader" class="text-center py-8 hidden">
            <svg class="animate-spin h-8 w-8 text-sky-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-slate-500 dark:text-slate-400">AI sedang berpikir...</p>
        </div>
    </div>


    <!-- Main Logic Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Element Selections ===
            const apiKeyInput = document.getElementById('api-key-input');
            const pasteArea = document.getElementById('paste-area');
            const fileUpload = document.getElementById('file-upload');
            const pastePlaceholder = document.getElementById('paste-placeholder');
            const pastedImage = document.getElementById('pasted-image');
            const outputText = document.getElementById('output-text');
            const clearBtn = document.getElementById('clear-btn');
            const copyBtn = document.getElementById('copy-btn');
            const saveBtn = document.getElementById('save-btn');
            const geminiExplainBtn = document.getElementById('gemini-explain-btn');
            const geminiTranslateBtn = document.getElementById('gemini-translate-btn');
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const notification = document.getElementById('notification');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIconLight = document.getElementById('theme-icon-light');
            const themeIconDark = document.getElementById('theme-icon-dark');
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const appContainer = document.getElementById('app-container');
            const viewBtns = document.querySelectorAll('.view-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const geminiModalOverlay = document.getElementById('gemini-modal-overlay');
            const geminiModalCloseBtn = document.getElementById('gemini-modal-close-btn');
            const geminiModalTitle = document.getElementById('gemini-modal-title');
            const geminiModalContent = document.getElementById('gemini-modal-content');
            const geminiModalLoader = document.getElementById('gemini-modal-loader');
            
            // The master prompt for Gemini Vision OCR - UPDATED
            const GEMINI_OCR_PROMPT = `Kamu adalah AI OCR Assistant yang sangat teliti dan akurat. Tugas utamamu adalah melakukan pemindaian (scan) dan ekstraksi teks (OCR) dari gambar secara otomatis setiap kali pengguna mengirim gambar, tanpa perlu perintah tambahan.

KEMAMPUAN UTAMA:
1. Mampu mengenali dan menyalin teks dalam:
   - Bahasa Indonesia (huruf Latin)
   - Bahasa Arab (dengan atau tanpa harakat)
2. Hasil ekstraksi harus:
   - Akurat, teliti, dan lengkap sesuai urutan teks pada gambar.
   - Tidak mengubah ejaan, tanda baca, atau posisi teks secara berarti.
   - Menjaga harakat dan tanda baca Arab agar tidak hilang.
3. Bila gambar berisi campuran teks Arab dan Indonesia, pisahkan hasilnya secara rapi per bahasa atau per paragraf.
4. Jika ada bagian teks yang tidak terbaca, tulis \`[tidak terbaca]\` pada bagian tersebut.
5. PENTING: Jangan mengganti atau menginterpretasi simbol kaligrafi seperti ﷺ, رضي الله عنه, dll. Salin simbol tersebut persis seperti yang terlihat di gambar. Fokus hanya pada ekstraksi visual, bukan interpretasi kontekstual.

FORMAT HASIL:
Tampilkan hasil dengan format berikut (tanpa komentar tambahan, analisis, atau penjelasan):

Hasil Ekstraksi:
(teks hasil scan ditulis di sini persis seperti yang terbaca di gambar)

Jangan tambahkan interpretasi, terjemahan, atau kalimat lain di luar hasil teks yang dipindai.

PERILAKU OTOMATIS:
- Setiap kali pengguna mengirim gambar (file, screenshot, atau tempel dari clipboard), langsung lakukan OCR dan kirim hasil dalam format di atas secara otomatis.
- Jangan menunggu konfirmasi atau instruksi tambahan seperti “tolong scan ini”.

CATATAN:
- Tetap berusaha memberikan hasil terbaik meski teks buram, melengkung, atau bercampur.
- Hasil akhir harus bisa langsung disalin tanpa format aneh atau simbol tersembunyi.`;

            // === API Key Management ===
            apiKeyInput.value = localStorage.getItem('geminiApiKey') || '';
            apiKeyInput.addEventListener('input', (e) => {
                localStorage.setItem('geminiApiKey', e.target.value);
            });
            
            // === UI Management ===
            const resetUI = () => {
                if (pastedImage.src) URL.revokeObjectURL(pastedImage.src);
                pastedImage.src = '';
                pastedImage.classList.add('hidden');
                pastePlaceholder.classList.remove('hidden');
                outputText.value = '';
                clearBtn.disabled = true;
                copyBtn.disabled = true;
                saveBtn.disabled = true;
                geminiExplainBtn.disabled = true;
                geminiTranslateBtn.disabled = true;
            };

            const openSidebar = () => sidebar.classList.remove('-translate-x-full');
            const closeSidebar = () => sidebar.classList.add('-translate-x-full');
            menuBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            viewBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    viewBtns.forEach(b => b.classList.remove('bg-slate-200', 'dark:bg-slate-800'));
                    btn.classList.add('bg-slate-200', 'dark:bg-slate-800');
                    appContainer.classList.remove('max-w-6xl', 'max-w-3xl', 'max-w-lg');
                    if (view === 'laptop') appContainer.classList.add('max-w-6xl');
                    else if (view === 'tablet') appContainer.classList.add('max-w-3xl');
                    else appContainer.classList.add('max-w-lg');
                });
            });

            // === Theme Management ===
            const applyTheme = (theme) => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                themeIconLight.classList.toggle('hidden', theme === 'dark');
                themeIconDark.classList.toggle('hidden', theme !== 'dark');
            };
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
            themeToggle.addEventListener('click', () => {
                const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            
            // === Gemini Modal Management ===
            const openGeminiModal = (title) => {
                geminiModalTitle.textContent = title;
                geminiModalContent.innerHTML = '';
                geminiModalLoader.classList.remove('hidden');
                geminiModal.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                geminiModalOverlay.classList.remove('opacity-0', 'pointer-events-none');
            };
            const closeGeminiModal = () => {
                geminiModal.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
                geminiModalOverlay.classList.add('opacity-0', 'pointer-events-none');
            };
            geminiModalCloseBtn.addEventListener('click', closeGeminiModal);
            geminiModalOverlay.addEventListener('click', closeGeminiModal);

            // === Helper to convert image file to Base64 ===
            const imageFileToBase64 = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type,
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
            
            // === Gemini API Calls ===
            const callGeminiAPI = async (payload, maxRetries = 3) => {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    showNotification('Kunci API Gemini belum diatur. Silakan masukkan di menu.', 'error');
                    return null;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                 // Add safety settings to the payload
                const fullPayload = {
                    ...payload,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                    ],
                };


                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fullPayload),
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) return text;
                        if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                             return "Maaf, permintaan ini tidak dapat diproses karena alasan keamanan.";
                        }
                        if (!result.candidates) {
                             console.error("API Response Error:", result);
                             return "Respons dari AI tidak valid. Kemungkinan kunci API salah atau ada masalah lain.";
                        }
                        throw new Error('No content in response.');
                    } catch (error) {
                        console.error(`Attempt ${attempt + 1} failed:`, error);
                        if (attempt === maxRetries - 1) return "Maaf, AI tidak dapat merespons saat ini. Coba lagi nanti.";
                        await new Promise(res => setTimeout(res, Math.pow(2, attempt) * 1000));
                    }
                }
            };
            
            // === Main OCR Processing Logic (Now using Gemini Vision) ===
            const processImage = async (imageFile) => {
                const apiKey = localStorage.getItem('geminiApiKey');
                if (!apiKey) {
                    showNotification('Silakan atur Kunci API Gemini Anda di menu samping.', 'error');
                    openSidebar();
                    return;
                }
                
                resetUI();
                pastedImage.src = URL.createObjectURL(imageFile);
                pastedImage.classList.remove('hidden');
                pastePlaceholder.classList.add('hidden');
                loader.classList.remove('hidden');
                
                try {
                    loaderText.textContent = `Mengubah format gambar...`;
                    const { mimeType, data: base64ImageData } = await imageFileToBase64(imageFile);

                    loaderText.textContent = `AI sedang memindai gambar...`;
                    
                    const payload = {
                        contents: [{
                            parts: [
                                { text: GEMINI_OCR_PROMPT },
                                { inlineData: { mimeType, data: base64ImageData } }
                            ]
                        }]
                    };

                    let resultText = await callGeminiAPI(payload);

                    if (resultText) {
                        resultText = resultText.replace(/^Hasil Ekstraksi:\s*/i, '').trim();
                    }
                    
                    outputText.value = resultText || "Tidak ada teks yang terdeteksi.";
                    showNotification(resultText ? 'Teks berhasil diekstrak!' : 'Tidak ada teks yang terdeteksi.', resultText ? 'success' : 'info');
                    
                    clearBtn.disabled = false;
                    if (resultText) {
                        copyBtn.disabled = false;
                        saveBtn.disabled = false;
                        geminiExplainBtn.disabled = false;
                        geminiTranslateBtn.disabled = false;
                    }
                } catch (error) {
                    console.error("OCR Error:", error);
                    outputText.value = "Terjadi kesalahan saat memproses gambar.";
                    showNotification('Gagal memproses gambar.', 'error');
                } finally {
                    loader.classList.add('hidden');
                }
            };

            // === Event Handlers ===
            document.onpaste = (event) => {
                const items = event.clipboardData.items;
                const imageFile = Array.from(items).find(item => item.type.includes('image'))?.getAsFile();
                if (imageFile) {
                    event.preventDefault();
                    processImage(imageFile);
                }
            };
            pasteArea.addEventListener('click', () => fileUpload.click());
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) processImage(file);
                event.target.value = null;
            });
            clearBtn.addEventListener('click', resetUI);
            copyBtn.addEventListener('click', () => navigator.clipboard.writeText(outputText.value).then(() => showNotification('Hasil berhasil disalin!')));
            saveBtn.addEventListener('click', () => {
                const blob = new Blob([outputText.value], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = Object.assign(document.createElement('a'), { href: url, download: 'hasil-ocr.txt' });
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showNotification('File .txt berhasil disimpan!');
            });
            geminiExplainBtn.addEventListener('click', async () => {
                const text = outputText.value;
                if (!text) return;
                openGeminiModal('Penjelasan dari AI ✨');
                const payload = { contents: [{ parts: [{ text: `Jelaskan teks berikut dalam Bahasa Indonesia yang ringkas dan mudah dipahami:\n\n---\n${text}\n---` }] }] };
                const result = await callGeminiAPI(payload);
                geminiModalLoader.classList.add('hidden');
                geminiModalContent.textContent = result;
            });
            geminiTranslateBtn.addEventListener('click', async () => {
                const text = outputText.value;
                if (!text) return;
                openGeminiModal('Terjemahan ke Indonesia ✨');
                const payload = { contents: [{ parts: [{ text: `Terjemahkan teks berikut ke dalam Bahasa Indonesia:\n\n---\n${text}\n---` }] }] };
                const result = await callGeminiAPI(payload);
                geminiModalLoader.classList.add('hidden');
                geminiModalContent.textContent = result;
            });

            // === Notification Helper ===
            let notificationTimeout;
            const showNotification = (message, type = 'success') => {
                notification.textContent = message;
                notification.className = 'fixed bottom-5 right-5 text-white text-sm py-2 px-4 rounded-lg shadow-lg transform transition-all duration-500 ease-out z-50'; // Reset
                if (type === 'success') notification.classList.add('bg-sky-600');
                else if (type === 'error') notification.classList.add('bg-red-600');
                else notification.classList.add('bg-slate-600');
                clearTimeout(notificationTimeout);
                notification.classList.remove('opacity-0', 'translate-y-20');
                notificationTimeout = setTimeout(() => {
                    notification.classList.add('opacity-0', 'translate-y-20');
                }, 3000);
            };
        });
    </script>
</body>
</html>
